# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Netlify Build Configuration for openSUSE Kudos
# Optimized for minimal bundle size and Netlify limits
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[build]
  base = ""

  command = """
  echo 'ğŸ“¦ Installing dependencies (including dev for build)...'
  npm ci --include=dev

  echo 'ğŸ—ï¸ Generating Prisma client and seeding database...'
  npx prisma generate --schema=backend/prisma/schema.prisma
  npx prisma db push --schema=backend/prisma/schema.prisma
  node backend/prisma/seed.js

  echo 'ğŸ¨ Building frontend with Vite...'
  npm run build:frontend

  echo 'ğŸ§¹ Pruning development dependencies...'
  npm prune --omit=dev

  echo 'ğŸª¶ Removing unused Prisma binaries...'
  find node_modules/@prisma/client -type f -name "libquery_engine-*.so.node" \
    ! -name "libquery_engine-linux-musl.so.node" -delete 2>/dev/null || true

  echo 'ğŸ§© Removing Prisma CLI (not needed in production)...'
  rm -rf node_modules/prisma

  echo 'ğŸ“ Final node_modules size:'
  du -sh node_modules || true

  echo 'âœ… Build and cleanup completed successfully.'
  """

  publish = "backend/public"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20"
  PRISMA_CLIENT_ENGINE_TYPE = "binary"
  NPM_FLAGS = "--include=dev"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Context overrides (previews and prod use same build)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[context.deploy-preview]
  command = """
  npm ci --include=dev
  npm run build:frontend
  npm prune --omit=dev
  """

[context.production]
  command = """
  npm ci --include=dev
  npm run build:frontend
  npm prune --omit=dev
  """

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Redirects
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/server/:splat"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Functions Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[functions]
  node_bundler = "esbuild"
  included_files = ["backend/**", "frontend/**"]
  external_node_modules = [
    "@prisma/client",
    "express",
    "serverless-http",
    "nanoid",
    "sharp"
  ]
