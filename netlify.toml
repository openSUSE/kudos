[build]
  base = ""
  command = """
  echo 'ğŸ“¦ Installing dependencies...'
  npm ci

  echo 'ğŸ—ï¸ Generating Prisma client (with explicit schema path)...'
  npx prisma generate --schema=backend/prisma/schema.prisma

  echo 'ğŸ—ƒï¸ Syncing database schema...'
  npx prisma db push --schema=backend/prisma/schema.prisma

  echo 'ğŸŒ± Seeding database...'
  node backend/prisma/seed.js || echo 'âš ï¸ Seed skipped or failed gracefully.'

  echo 'ğŸ—ï¸ Building frontend...'
  npm run build:frontend

  echo 'ğŸ§¹ Pruning devDependencies...'
  npm prune --production

  echo 'ğŸª¶ Removing unused Prisma binaries...'
  find node_modules/@prisma/client -type f -name "libquery_engine-*.so.node" \
    ! -name "libquery_engine-linux-musl.so.node" -delete 2>/dev/null || true

  echo 'ğŸ§© Removing Prisma CLI (not needed in production)...'
  rm -rf node_modules/prisma

  echo 'ğŸ“ Final node_modules size:'
  du -sh node_modules || true

  echo 'âœ… Build and cleanup completed successfully.'
  """
  publish = "backend/public"
  functions = "netlify/functions"

[build.environment]
  PRISMA_CLIENT_ENGINE_TYPE = "binary"
  NPM_FLAGS = "--include=dev"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Context overrides
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[context.deploy-preview]
  command = "npm ci && npm run build:frontend && npm prune --production"

[context.production]
  command = "npm ci && npm run build:frontend && npm prune --production"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Redirects
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/server/:splat"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Functions configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[functions]
  node_bundler = "esbuild"
  included_files = [
    "backend/**",
    "frontend/public/fonts/**"
  ]
  external_node_modules = [
    "@prisma/client",
    "express",
    "serverless-http",
    "nanoid",
    "sharp"
  ]
