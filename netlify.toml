# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Netlify Build Configuration for openSUSE Kudos
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[build]
  base = ""
  command = """
  echo 'ğŸ“¦ Installing dependencies (including dev for build)...'
  NODE_ENV=development npm ci --include=dev

  echo 'ğŸ”§ Ensuring @vitejs/plugin-vue is installed (Netlify workaround)...'
  if [ ! -d "node_modules/@vitejs/plugin-vue" ]; then
    npm install -D @vitejs/plugin-vue
  fi

  echo 'ğŸ—ï¸ Generating Prisma client and seeding database...'
  npx prisma generate --schema=backend/prisma/schema.prisma
  npx prisma db push --schema=backend/prisma/schema.prisma
  node backend/prisma/seed.js

  echo 'ğŸ¨ Building frontend with Vite...'
  npm run build:frontend || (echo 'âŒ Frontend build failed!' && exit 1)

  echo 'ğŸ§¹ Pruning devDependencies...'
  npm prune --omit=dev

  echo 'ğŸª¶ Removing unused Prisma binaries...'
  find node_modules/@prisma/client -type f -name "libquery_engine-*.so.node" \
    ! -name "libquery_engine-linux-musl.so.node" -delete 2>/dev/null || true

  echo 'ğŸ§© Removing Prisma CLI (not needed in production)...'
  rm -rf node_modules/prisma

  echo 'ğŸ“ Final node_modules size:'
  du -sh node_modules || true

  echo 'âœ… Build and cleanup completed successfully.'
  """
  publish = "backend/public"
  functions = "netlify/functions"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Build environment
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[build.environment]
  NODE_VERSION = "20"
  PRISMA_CLIENT_ENGINE_TYPE = "binary"
  NPM_FLAGS = "--include=dev"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Context overrides (deploy-preview and production)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[context.deploy-preview]
  command = """
  echo 'ğŸ“¦ Installing dependencies (including dev for build)...'
  NODE_ENV=development npm ci --include=dev

  echo 'ğŸ”§ Ensuring @vitejs/plugin-vue is installed (Netlify workaround)...'
  if [ ! -d "node_modules/@vitejs/plugin-vue" ]; then
    npm install -D @vitejs/plugin-vue
  fi

  echo 'ğŸ¨ Building frontend with Vite...'
  npm run build:frontend || (echo 'âŒ Frontend build failed!' && exit 1)

  echo 'ğŸ§¹ Cleaning up...'
  npm prune --omit=dev
  """

[context.production]
  command = """
  echo 'ğŸ“¦ Installing dependencies (including dev for build)...'
  NODE_ENV=development npm ci --include=dev

  echo 'ğŸ”§ Ensuring @vitejs/plugin-vue is installed (Netlify workaround)...'
  if [ ! -d "node_modules/@vitejs/plugin-vue" ]; then
    npm install -D @vitejs/plugin-vue
  fi

  echo 'ğŸ¨ Building frontend with Vite...'
  npm run build:frontend || (echo 'âŒ Frontend build failed!' && exit 1)

  echo 'ğŸ§¹ Cleaning up...'
  npm prune --omit=dev
  """

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Redirects (API + SPA)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/server/:splat"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Functions configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[functions]
  node_bundler = "esbuild"
  included_files = ["backend/**", "frontend/**"]
  external_node_modules = [
    "@prisma/client",
    "express",
    "serverless-http",
    "nanoid",
    "sharp",
    "cors",
    "cookie-parser",
    "express-session",
    "bcrypt",
    "openid-client"
  ]
