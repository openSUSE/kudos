[build]
  base = ""
  command = "npm ci && npm run build:all"
  publish = "frontend/dist"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20"
  NODE_ENV = "development"            # Force devDependencies to install
  NPM_FLAGS = "--include=dev"         # Ensure vite + prisma install
  PRISMA_CLIENT_ENGINE_TYPE = "binary"
  DATABASE_URL = "file:/tmp/dev.db"   # Temp SQLite file for each build
  AUTH_MODE = "LOCAL"

# ─────────────────────────────────────────────
# Context overrides
# ─────────────────────────────────────────────

[context.deploy-preview]
  command = "npm ci && npm run build:all"
  environment = { VITE_APP_ENV = "preview", PREVIEW_MODE = "true" }

[context.production]
  command = "npm ci && npm run build:all"
  environment = { VITE_APP_ENV = "production", PREVIEW_MODE = "false" }

# ─────────────────────────────────────────────
# Redirects
# ─────────────────────────────────────────────

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/server/:splat"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
